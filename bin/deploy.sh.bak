#!/bin/bash
# bin/deploy.sh - Main deployment script
# Repo: https://github.com/MkhanyisiNdlanga/rock-paper-scissors-MkhanyisiNdlanga
# Branch: CoT_data-analytics-hub
# Author: Mkhanyisi Ndlanga

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

APP_IMAGE="data-analytics-app:latest"
PREV_IMAGE="data-analytics-app:backup"
DEPLOY_SCRIPT="$SCRIPT_DIR/deploy-app.sh"
HEALTH_SCRIPT="$SCRIPT_DIR/health-check.sh"

APP_CONTAINER="analytics-app"   # Should match deploy-app.sh
MINIO_CONTAINER="minio-server"  # Should match deploy-app.sh

echo "== Checking environment =="
command -v docker >/dev/null || { echo "Docker not found"; exit 1; }
command -v python3 >/dev/null || { echo "Python3 not found"; exit 1; }

echo "== Running lint =="
python3 -m py_compile "$PROJECT_ROOT/resources/app.py" || {
  echo "Lint failed"; exit 1;
}

echo "== Building image =="
if docker image inspect "$APP_IMAGE" >/dev/null 2>&1; then
  docker tag "$APP_IMAGE" "$PREV_IMAGE"
fi

docker build -t "$APP_IMAGE" "$PROJECT_ROOT" || {
  echo "Build failed"; exit 1;
}

echo "== Deploying stack =="
bash "$DEPLOY_SCRIPT"

echo "== Verifying deployment =="
if bash "$HEALTH_SCRIPT"; then
  echo "Deployment successful"
  docker image rm "$PREV_IMAGE" >/dev/null 2>&1 || true
else
  echo "Health check failed â€“ rolling back..."
  # Stop current containers
  docker stop "$APP_CONTAINER" "$MINIO_CONTAINER" >/dev/null 2>&1 || true
  docker rm "$APP_CONTAINER" "$MINIO_CONTAINER" >/dev/null 2>&1 || true

  # Rollback previous app image
  if docker image inspect "$PREV_IMAGE" >/dev/null 2>&1; then
    echo "Restoring previous app version..."
    docker run -d --name "$APP_CONTAINER" -p 127.0.0.1:8000:5000 "$PREV_IMAGE"
    echo "Rollback complete"
  fi

  exit 1
fi